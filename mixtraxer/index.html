<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Mixtraxer</title>
    <style>
        body {
            font-family: system-ui;
            display: flex;
            flex-direction: column;
            gap: 1em;
            align-items: center;
            height: 100vh;
            justify-content: center;
            background-color: black;
            margin: 0;
            color: white;
            &>div {
                display: inherit;
                flex-direction: row;
                gap: .5em;
            }
        }

        input[type="file"] {
            background-color: #101010;
            border-radius: .5em;
            padding: .5em;
        }

        button {
            padding: .5em .8em;
            background-color: rgb(23, 50, 27);
            color: rgb(32, 255, 132);
            font-size: 1.5em;
            border: none;
            border-radius: 1.5em;
        }
    </style>
</head>

<body>
    <h1>Mixtraxer</h1>
    <p>Causes dizziness, disorientation and if exposed to for long periods, mild nausea.</p>
    <input id="leftFile" type="file" accept="audio/*">
    <input id="rightFile" type="file" accept="audio/*">
    <label>Speed <input id="speed" type="range" min="0.1" max="5" step="0.1" value="1"></label>
    <div><button id="play">Play</button>
    <button id="stop">Stop</button></div>

    <script>
        let ac, leftElem, rightElem, leftSrc, rightSrc, leftPanner, rightPanner;
        let orbit = true, t = 0;

        function ensureCtx() {
            if (!ac) ac = new (window.AudioContext || window.webkitAudioContext)();
        }

        function makeElements() {
            leftElem = new Audio(); rightElem = new Audio();
            leftElem.loop = true; rightElem.loop = true;
            leftSrc = ac.createMediaElementSource(leftElem);
            rightSrc = ac.createMediaElementSource(rightElem);
            leftPanner = ac.createPanner(); rightPanner = ac.createPanner();
            [leftPanner, rightPanner].forEach(p => {
                p.panningModel = 'HRTF';
                p.distanceModel = 'inverse';
                p.refDistance = 1;
                p.maxDistance = 10000;
            });
            leftSrc.connect(leftPanner).connect(ac.destination);
            rightSrc.connect(rightPanner).connect(ac.destination);
        }

        function load(elem, file) {
            if (!file) return;
            const url = URL.createObjectURL(file);
            elem.src = url; elem.load();
        }

        function animate() {
            if (!orbit) return;
            t += 0.02 * parseFloat(speed.value);
            const lx = Math.cos(t) * 1, lz = Math.sin(t) * 1;
            const rx = Math.cos(t + Math.PI) * 1, rz = Math.sin(t + Math.PI) * 1;
            leftPanner.positionX.value = lx; leftPanner.positionY.value = 0; leftPanner.positionZ.value = lz;
            rightPanner.positionX.value = rx; rightPanner.positionY.value = 0; rightPanner.positionZ.value = rz;
            requestAnimationFrame(animate);
        }

        play.onclick = async () => {
            ensureCtx();
            if (!leftElem) makeElements();
            load(leftElem, leftFile.files[0]);
            load(rightElem, rightFile.files[0]);
            await ac.resume();
            leftElem.play(); rightElem.play();
            orbit = true; animate();
        };

        stop.onclick = () => {
            orbit = false;
            if (leftElem) { leftElem.pause(); leftElem.currentTime = 0; }
            if (rightElem) { rightElem.pause(); rightElem.currentTime = 0; }
        };
    </script>
</body>

</html>